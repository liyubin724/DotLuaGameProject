require ("DotLua/Class")
require("DotLua/Delegate")

local DebugLog = DebugLog

EnvManager =
    Class(
    function(self)
        self.updateDelegate = Delegate()
        self.startupDelegate = Delegate()

        self.updateInterval = 0.1
        self.elapseInterval = 0
    end
)

function EnvManager:AddUpdateDelegate(receiver,func)
    self.updateDelegate = self.updateDelegate + {receiver,func}
end

function EnvManager:RemoveUpdateDelegate(receiver,func)
    self.updateDelegate = self.updateDelegate - {receiver,func}
end

function EnvManager:AddStartupDelegate(receiver,func)
    self.startupDelegate = self.startupDelegate + {receiver,func}
end

function EnvManager:RemoveStartupDelegate(receiver,func)
    self.startupDelegate = self.startupDelegate - {receiver,func}
end

function EnvManager:DoStart()
    DebugLog.Info("EnvMgr", "EnvMgr started")
end

function EnvManager:DoStartup()

    Game.AssetMgr:InstanceAssetAsync("Cube",self,nil,EnvManager.OnCubeLoadComplete)

    if #(self.startupDelegate) > 0 then
        self.startupDelegate:Invoke()
    end
end

function EnvManager:DoUpdate(deltaTime)
    self.elapseInterval = self.elapseInterval + deltaTime
    if self.elapseInterval >= self.updateInterval then
        self.elapseInterval = self.elapseInterval - self.updateInterval

        if #(self.updateDelegate) > 0 then
            self.updateDelegate:Invoke(self.updateInterval)
        end

    end
end


--------------------Test---------------------------
function EnvManager:OnCubeLoadComplete(address,uObject,userdata)
    DebugLog.Info("EnvManager", "Cube loaded")

    local transform = uObject.transform
    transform.localPosition = CS.UnityEngine.Vector3.one
end