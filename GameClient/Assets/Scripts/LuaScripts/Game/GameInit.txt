local oop = require('DotLua/OOP/oop')
local CycleTime = require('DotLua/CycleTime')
local Logger = require('DotLua/Debug/Logger')
local GameECS = oop.using('Game/ECS/GameECS')
local MsgDispatcher = oop.using('DotLua/Message/MsgDispatcher')
local UIDCreator = oop.using('DotLua/Generic/UIDCreator')

local DELogUtil = CS.DotEngine.Log.LogUtil

if _G.isDebug then
    require('Debugger/LuaPanda').start('127.0.0.1', 8818)
    Logger.SetEnable(true, true, true)
else
    Logger.SetEnable(false, false, true)
end
Logger.SetFunc(DELogUtil.Info, DELogUtil.Warning, DELogUtil.Error)

game = {}

game.DoStart = function()
    game.uidCreator = UIDCreator()
    game.dispatcher = MsgDispatcher()

    game.ecs = GameECS(game.uidCreator, game.dispatcher)
    local StartupSystem = oop.using('Game/Startup/StartupSystem')
    game.ecs:AddSystem(StartupSystem())

    game.ecs:DoInitialize()
end

game.DoUpdate = function(deltaTime, unscaleDeltaTime)
    CycleTime.DoUpdate(deltaTime, unscaleDeltaTime)
    game.ecs:DoUpdate()
end

game.DoLateUpdate = function()
    game.ecs:DoLateUpdate()
end

game.DoDestroy = function()
    game.ecs:DoTeardown()
    game.ecs = nil
end
