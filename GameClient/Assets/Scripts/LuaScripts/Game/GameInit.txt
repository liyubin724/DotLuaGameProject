local oop = require('DotLua/OOP/oop')
local Logger = require('DotLua/Debug/Logger')
local HTimer = require('DotLua/Timer/HierarchicalTimer')
local CycleTime = require('DotLua/CycleTime')
local ecs = oop.using('DotLua/ECS/ecs')

local ContextNames = require('Game/ECS/Contexts/ContextNames')
local GameContext = require('Game/ECS/Contexts/GameContext')


local StartupSystem = oop.using('Game/Startup/StartupSystem')
local DELogUtil = CS.DotEngine.Log.LogUtil

if _G.isDebug then
    require('Debugger/LuaPanda').start('127.0.0.1', 8818)
    Logger.SetEnable(true, true, true)
else
    Logger.SetEnable(false, false, true)
end
Logger.SetFunc(DELogUtil.Info, DELogUtil.Warning, DELogUtil.Error)

_G.Game = {}

Game.GetECS = function()
    if not Game.gameECS then
        Game.gameECS = ecs()
    end

    return Game.gameECS
end

Game.GetContext = function()

end

Game.DoStart = function()
    local gameECS = Game.GetECS()

    gameECS:AddContext(GameContext(ContextNames.GameContextName))
    
    gameECS:AddServicer('HTimer', HTimer())

    gameECS:AddSystem(StartupSystem())

    gameECS:DoInitialize()
end

Game.DoUpdate = function(deltaTime, unscaleDeltaTime)
    CycleTime.DoUpdate(deltaTime, unscaleDeltaTime)
    Game.gameECS:DoUpdate()
end

Game.DoLateUpdate = function()
    Game.gameECS:DoLateUpdate()
end

Game.DoDestroy = function()
    Game.gameECS:DoTeardown()
    Game.gameECS = nil
end
