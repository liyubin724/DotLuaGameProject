local oop = require('DotLua/OOP/oop')
local CycleTime = require('DotLua/CycleTime')
local Logger = require('DotLua/Debug/Logger')
local GameECS = oop.load('Game/ECS/GameECS')
local MsgDispatcher = oop.load('DotLua/Message/MsgDispatcher')
local UIDCreator = oop.load('DotLua/Generic/UIDCreator')
local Language = oop.load('DotUnity/Language')
local App = oop.load('DotUnity/App')

local DELogUtil = CS.DotEngine.Log.LogUtil

if _G.isDebug then
    require('Debugger/LuaPanda').start('127.0.0.1', 8818)
    Logger.SetEnable(true, true, true)
else
    Logger.SetEnable(false, false, true)
end
Logger.SetFunc(DELogUtil.Info, DELogUtil.Warning, DELogUtil.Error)

local GetLanguageFileName = function(languageType)
    if languageType == Language.Chinese or languageType == Language.ChineseSimplified then
        return 'ZH_CN'
    elseif languageType == Language.ChineseTraditional then
        return 'ZH_TC'
    end

    return nil
end

Game = {}
Game.languageType = nil
Game.language = nil

Game.SetLanguage = function(languageType)
    if Game.languageType == languageType then
        return
    end

    if Game.languageType then
        Game.language = nil
        local languagePath = string.format('Game/Localization/%s',GetLanguageFileName(Game.languageType))
        oop.unload(languagePath)
    end

    Game.languageType = languageType

    if Game.languageType then
        local languagePath = string.format('Game/Localization/%s',GetLanguageFileName(Game.languageType))
        Game.language = oop.load(languagePath)
    end

    CS.DotEngine.Lua.LuaEnvManager.GetInstance():SetLanguage(Game.language)
end

Game.DoInit = function()
    Game.SetLanguage(App.GetSystemLanguage())
    Game.uidCreator = UIDCreator()
    Game.dispatcher = MsgDispatcher()
end

Game.DoStart = function()
    Game.ecs = GameECS(Game.uidCreator, Game.dispatcher)
    local StartupSystem = oop.using('Game/Startup/StartupSystem')
    Game.ecs:AddSystem(StartupSystem())

    Game.ecs:DoInitialize()
end

Game.DoUpdate = function(deltaTime, unscaleDeltaTime)
    CycleTime.DoUpdate(deltaTime, unscaleDeltaTime)
    Game.ecs:DoUpdate()
end

Game.DoLateUpdate = function()
    Game.ecs:DoLateUpdate()
end

Game.DoDestroy = function()
    Game.ecs:DoTeardown()
    Game.ecs = nil
end
