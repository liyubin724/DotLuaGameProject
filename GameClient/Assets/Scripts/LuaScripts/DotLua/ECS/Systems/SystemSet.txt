local oop = require('DotLua/OOP/oop')

local UpdateSystem = oop.using('DotLua/ECS/Systems/LifeCycle/UpdateSystem')
local LateUpdateSystem = oop.using('DotLua/ECS/Systems/LifeCycle/LateUpdateSystem')
local FrameSystem = oop.using('DotLua/ECS/Systems/LifeCycle/FrameSystem')

local select = select
local tinsert = table.insert
local tremove = table.remove
local tforeach = table.foreach

local SystemSet =
    oop.class(
    'SystemSet',
    function(self, dispatcher, ...)
        self.dispatcher = dispatcher

        self.updateSystems = {}
        self.lateUpdateSystems = {}
        self.frameSystems = {}

        self.systems = {}

        local length = select('#', ...)
        if length > 0 then
            for i = 1, length, 1 do
                local systemClass = select(i, ...)
                self:Add(systemClass)
            end
        end
    end
)

function SystemSet:Add(systemClass)
    if oop.isDebug then
        if not systemClass or not oop.isclass(systemClass) or not oop.iskindof(System) then
            oop.error('ECS', 'MacroSystem:Add->the param is not a instance of System')
            return
        end
    end

    local system = systemClass(self.dispatcher)

    if oop.iskindof(system, UpdateSystem) then
        tinsert(self.updateSystems, system)
    elseif oop.iskindof(system, LateUpdateSystem) then
        tinsert(self.lateUpdateSystems, system)
    elseif oop.iskindof(system, FrameSystem) then
        tinsert(self.frameSystems, system)
    else
        oop.error('ECS', 'MacroSystem:Add->the param is not a subclass of System')
        return
    end

    tinsert(self.systems, system)

    return system
end

function SystemSet:Remove(systemClass)
    if oop.isDebug then
        if not systemClass or not oop.isclass(systemClass) or not oop.iskindof(System) then
            oop.error('ECS', 'MacroSystem:Remove->the param is not a instance of System')
            return
        end
    end

    local system = self:removeFrom(self.systems, systemClass)
    if oop.iskindof(systemClass, UpdateSystem) then
        self:removeFrom(self.updateSystems, systemClass)
    elseif oop.iskindof(systemClass, LateUpdateSystem) then
        self:removeFrom(self.lateUpdateSystems, systemClass)
    elseif oop.iskindof(systemClass, FrameSystem) then
        self:removeFrom(self.frameSystems, systemClass)
    end

    return system
end

function SystemSet:removeFrom(systems, systemClass)
    for i = #systems, 1, -1 do
        if oop.iskindof(systems[i], systemClass) then
            local system = systems[i]
            tremove(systems, i)
            return system
        end
    end
end

function SystemSet:DoInitialize()
    tforeach(
        self.systems,
        function(system)
            system:DoInitialize()
        end
    )
end

function SystemSet:DoUpdate()
    tforeach(
        self.updateSystems,
        function(system)
            system:DoUpdate()
        end
    )
end

function SystemSet:DoLateUpdate()
    tforeach(
        self.updateSystems,
        function(system)
            system:DoLateUpdate()
        end
    )
end

function SystemSet:DoFrame()
    tforeach(
        self.frameSystems,
        function(system)
            system:DoFrame()
        end
    )
end

function SystemSet:DoTeardown()
    tforeach(
        self.systems,
        function(system)
            system:DoTeardown()
        end
    )
end

return SystemSet
