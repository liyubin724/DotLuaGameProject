local oop = require('DotLua/OOP/oop')

local System = require('DotLua/ECS/Systems/System')
local SystemUtility = require('DotLua/ECS/Systems/SystemUtility')
local CycleTime = require('DotLua/CycleTime')

local tinsert = table.insert
local tremovevalue = table.removevalue
local tclear = table.clear

local SystemSet =
    oop.class(
    'SystemSet',
    function(self)
        self.isInited = false
        self.elapseTime = 0
    end
)

function SystemSet:Add(system)
    if oop.isDebug then
        if not system or not oop.isinstanceof(system, System) then
            oop.error('ECS', 'MacroSystem:Add->the param is not a instance of System')
            return
        end
    end

    tinsert(self.systems, system)

    if self.isInited and system[SystemUtility.FUNC_NAME_INITIZLIZE] then
        system[SystemUtility.FUNC_NAME_INITIZLIZE]()
    end
end

function SystemSet:Remove(system)
    if oop.isDebug then
        if not system or not oop.isinstanceof(system, System) then
            oop.error('ECS', 'MacroSystem:Remove->the param is not a instance of System')
            return
        end
    end

    tremovevalue(self.systems, system)

    if self.isInited and system[SystemUtility.FUNC_NAME_TEARDOWN] then
        system[SystemUtility.FUNC_NAME_TEARDOWN]()
    end
end

function SystemSet:DoInitialize()
    self.isInited = true
    for _, system in ipairs(self.systems) do
        if system[SystemUtility.FUNC_NAME_INITIZLIZE] then
            system[SystemUtility.FUNC_NAME_INITIZLIZE]()
        end
    end
end

function SystemSet:DoUpdate()
    if self.isInited then
        for _, system in ipairs(self.systems) do
            if system[SystemUtility.FUNC_NAME_UPDATE] then
                system[SystemUtility.FUNC_NAME_UPDATE]()
            end
        end

        self.elapseTime = self.elapseTime + CycleTime.GetDeltaTime()
        while self.elapseTime > CycleTime.GetFrameTime() do
            for _, system in ipairs(self.systems) do
                if system[SystemUtility.FUNC_NAME_FRAME] then
                    system[SystemUtility.FUNC_NAME_FRAME]()
                end
            end

            self.elapseTime = self.elapseTime - CycleTime.GetFrameTime()
        end
    end
end

function SystemSet:DoLateUpdate()
    if self.isInited then
        for _, system in ipairs(self.systems) do
            if system[SystemUtility.FUNC_NAME_LATEUPDATE] then
                system[SystemUtility.FUNC_NAME_LATEUPDATE]()
            end
        end
    end
end

function SystemSet:DoTeardown()
    if self.isInited then
        for _, system in ipairs(self.systems) do
            if system[SystemUtility.FUNC_NAME_TEARDOWN] then
                system[SystemUtility.FUNC_NAME_TEARDOWN]()
            end
        end
    end
    tclear(self.systems)
    self.elapseTime = 0
end

return SystemSet
