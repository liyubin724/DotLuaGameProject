local oop = require('DotLua/OOP/oop')
local System = oop.using('DotLua/ECS/Core/System')

local tinsert = table.insert
local tforeach = table.foreach
local Const = require("DotLua/ECS/Const")

local LogTag = 'MacroSystem'

local MacroSystem =
    oop.class(
    'DotLua.ECS.Core.MacroSystem',
    function(self)
        self.subSystems = {}

        self.updateSystems = {}
        self.lateUpdateSystems = {}

        self:initSubsystems()
    end,
    System
)

function MacroSystem:initSubsystems()
end

function MacroSystem:AddSubsystem(subSystem)
    if oop.isDebug then
        if not subSystem or not oop.isinstanceof(subSystem, System) then
            oop.error(LogTag, 'The subSystem is not a instance of System')
            return
        end
    end

    tinsert(self.subSystems, subSystem)
    if subSystem[Const.DO_UPDATE_FUNC_NAME] then
        tinsert(self.updateSystems, subSystem)
    end

    if subSystem[Const.DO_LATEUPDATE_FUNC_NAME] then
        tinsert(self.lateUpdateSystems, subSystem)
    end
end

function MacroSystem:DoUpdate(deltaTime, unscaleDeltaTime)
    if #(self.updateSystems) > 0 then
        tforeach(
            self.updateSystems,
            function(_, system)
                system:DoUpdate(deltaTime, unscaleDeltaTime)
            end
        )
    end
end

function MacroSystem:DoLateUpdate(deltaTime, unscaleDeltaTime)
    if #(self.lateUpdateSystems) > 0 then
        tforeach(
            self.lateUpdateSystems,
            function(_, system)
                system:DoLateUpdate(deltaTime, unscaleDeltaTime)
            end
        )
    end
end

function MacroSystem:onInitilize()
    if #(self.subSystems) > 0 then
        tforeach(
            self.subSystems,
            function(_, system)
                system:DoInitilize()
            end
        )
    end
end

function MacroSystem:onActivate()
    if #(self.subSystems) > 0 then
        tforeach(
            self.subSystems,
            function(_, system)
                system:DoActivate()
            end
        )
    end
end

function MacroSystem:onDeactivate()
    if #(self.subSystems) > 0 then
        tforeach(
            self.subSystems,
            function(_, system)
                system:DoDeactivate()
            end
        )
    end
end

function MacroSystem:onDestroy()
    tforeach(
        self.subSystems,
        function(_, system)
            system:DoDestroy()
        end
    )
    self.subSystems = nil
    self.updateSystems = nil
    self.lateUpdateSystems = nil
end

return MacroSystem
