local oop = require("DotLua/OOP/oop")
local System = require("DotLua/ECS/Core/System")
local Const = require("DotLua/ECS/Const")

local tinsert = table.insert
local tremovevalue = table.removevalue
local tforeach = table.foreach

local LogTag = "SystemMgr"

local Systems =
    oop.class(
    "DotLua.ECS.Core.Systems",
    function(self)
        self.nameToSystemDic = {}

        self.updateSystems = {}
    end
)

function Systems:RegisterSystem(name, systemClass, ...)
    if oop.isDebug then
        if not oop.iskindof(systemClass, System) then
            oop.error(LogTag, "the system is nil or is not a class of System")
            return
        end
    end

    local system = self.nameToSystemDic[name]
    if system then
        oop.error(LogTag, "the system has been registered in to systems.name = %s,system = ", name, tostring(system))
        return nil
    end

    system = systemClass(...)
    system:DoInitialize()
    self.nameToSystemDic[name] = system

    if system[Const.DO_UPDATE_FUNC_NAME] then
        self:insertSystem(self.updateSystems, system)
    end

    system:DoActivate()

    return system
end

function Systems:UnregisterSystem(name, isAutoDestroy)
    local system = self.nameToSystemDic[name]
    if not system then
        oop.warning(LogTag, "the system is not found")
        return
    end

    self.nameToSystemDic[name] = nil

    if system[Const.DO_UPDATE_FUNC_NAME] then
        tremovevalue(self.updateSystems, system)
    end

    system:DoDeactivate()
    if isAutoDestroy == nil or isAutoDestroy then
        system:DoDestroy()
    end
end

function Systems:DoUpdate(deltaTime, unscaleDeltaTime)
    tforeach(
        self.updateSystems,
        function(_, system)
            system:DoUpdate(deltaTime, unscaleDeltaTime)
        end
    )
end

function Systems:DoDestroy()
    tforeach(
        self.nameToSystemDic,
        function(_, system)
            system:DoDestroy()
        end
    )

    self.updateSystems = nil
    self.nameToSystemDic = nil
end

function Systems:insertSystem(systems, system)
    local priority = system:GetPriority()
    for i = 1, #systems do
        local sp = systems[i]:GetPriority()
        if priority < sp then
            tinsert(systems, system)
            return
        end
    end
    tinsert(systems, system)
end

return Systems
