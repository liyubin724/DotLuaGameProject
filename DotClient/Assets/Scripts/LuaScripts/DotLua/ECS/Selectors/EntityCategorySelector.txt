local oop = require("DotLua/OOP/oop")
local EntitySelector = require("DotLua/ECS/Core/EntitySelector")
local ContextEvent = require("DotLua/ECS/Core/ContextEvent")
local ECSConst = require("DotLua/ECS/ECSConst")
local CategoryComponent = require("DotLua/ECS/Components/Basic/CategoryComponent")

local tinsert = table.insert
local tremovevalue = table.removevalue

local EntityCategorySelector =
    oop.class(
    "DotLua.ECS.Core.EntityCategorySelector",
    function(self, name)
        self.categoryToEntityDic = {}
        self.entityToCategoryDic = {}
    end,
    EntitySelector
)

function EntityCategorySelector:GetResult(categoryID)
    return self.categoryToEntityDic[categoryID]
end

function EntityCategorySelector:TryToUpdateEntity(entity, contextEvent, param1, param2)
    if contextEvent == ContextEvent.EntityCreated then
        self:addEntity(entity)
    elseif contextEvent == ContextEvent.EntityReleased then
        self:removeEntity(entity)
    end
end

function EntityCategorySelector:addEntity(entity)
    if self.entityToCategoryDic[entity] then
        return
    end

    local categoryComponent = entity:GetComponent(CategoryComponent)
    local categoryID = ECSConst.CATEGORY_DEFAULT_ID
    if categoryComponent then
        categoryID = categoryComponent:GetCategoryID()
    end

    local categoryEntities = self.categoryToEntitiesDic[categoryID]
    if not categoryEntities then
        categoryEntities = {}
        self.categoryToEntitiesDic[categoryID] = categoryEntities
    end

    self.entityToCategoryDic[entity] = categoryID
    tinsert(categoryEntities, entity)
end

function EntityCategorySelector:removeEntity(entity)
    if not self.entityToCategoryDic[entity] then
        return
    end

    self.entityToCategoryDic[entity] = nil

    local categoryComponent = entity:GetComponent(CategoryComponent)
    local categoryID = ECSConst.CATEGORY_DEFAULT_ID
    if categoryComponent then
        categoryID = categoryComponent:GetCategoryID()
    end
    local categoryEntities = self.categoryToEntitiesDic[categoryID]
    tremovevalue(categoryEntities, entity)
end

return EntityCategorySelector
