local oop = require("DotLua/OOP/oop")
local Const = require("DotLua/ECS/Const")
local Contexts = require("DotLua/ECS/Core/Contexts")
local Systems = require("DotLua/ECS/Core/Systems")
local DestroySystem = require("DotLua/ECS/Systems/Basic/DestroySystem")
local GUIDCollectionSystem = require("DotLua/ECS/Systems/Basic/GUIDCollectionSystem")
local CategoryCollectionSystem = require("DotLua/ECS/Systems/Basic/CategoryCollectionSystem")
local HaveComponentMatcher = require("DotLua/ECS/Matchers/Components/HaveComponentMatcher")
local DestroyComponent = require("DotLua/ECS/Components/Basic/DestroyComponent")
local CategoryCollectionComponent = require("DotLua/ECS/Components/Basic/CategoryCollectionComponent")
local GUIDCollectionComponent = require("DotLua/ECS/Components/Basic/GUIDCollectionComponent")
local DependedCollectionComponent = require("DotLua/ECS/Components/Basic/DependedCollectionComponent")
local MsgDispatcher = require("DotLua/Message/MsgDispatcher")

local Env =
    oop.class(
    "DotLua.ECS.Env",
    function(self)
        self.contexts = nil
        self.systems = nil
        self.collectionEntity = nil

        self.msgDispatcher = MsgDispatcher()
    end
)

function Env:GetContexts()
    return self.contexts
end

function Env:GetSystems()
    return self.systems
end

function Env:GetMsgDispatcher()
    return self.msgDispatcher
end

function Env:GetCollectionEntity()
    return self.collectionEntity
end

function Env:DoInitlize()
    self.contexts = Contexts()
    self.systems = Systems()

    self.collectionEntity = self.contexts:GetOrCreateGlobalEntity(Const.GLOBAL_ENTITY_COLLECTION_NAME)
    self.collectionEntity:AddComponent(CategoryCollectionComponent)
    self.collectionEntity:AddComponent(GUIDCollectionComponent)
    self.collectionEntity:AddComponent(DependedCollectionComponent)

    local func = self[Const.ON_INITILIZE_FUNC_NAME]
    if func and type(func) == "function" then
        func(self)
    end

    self.contexts:BindContextEvent(self, self.onContextCreatedEvent, self.onContextReleasedEvent)

    self:onContextsInitilized()
    self:onSystemsInitilized()
end

function Env:DoUpdate(deltaTime, unscaleDeltaTime)
    self.systems:DoUpdate(deltaTime, unscaleDeltaTime)
end

function Env:DoLateUpdate(deltaTime, unscaleDeltaTime)
    self.systems:DoLateUpdate(deltaTime, unscaleDeltaTime)
    self.contexts:DoLateUpdate()
end

function Env:DoDestroy()
    if self[Const.ON_DESTROY_FUNC_NAME] then
        self[Const.ON_DESTROY_FUNC_NAME](self)
    end

    self.systems:DoDestroy()
    self.systems = nil

    self.contexts:DoDestroy()
    self.contexts = nil
end

function Env:onContextCreatedEvent(context)
    local destroySystemName = string.format("%s-DestroySystem", context:GetName())
    self.systems:RegisterSystem(destroySystemName, DestroySystem, context)

    local guidCollectionSystemName = string.format("%s-GUIDCollecionSystem",context:GetName())
    self.systems:RegisterSystem(guidCollectionSystemName, GUIDCollectionSystem, context)

    local categoryCollectionSystemName = string.format("%s-CategoryCollecionSystem", context:GetName())
    self.systems:RegisterSystem(categoryCollectionSystemName, CategoryCollectionSystem, context)

    local dependedCollectionSystemName = string.format("%s-DependedCollectionSystem", context:GetName())
    self.systems:RegisterSystem(dependedCollectionSystemName, CategoryCollectionSystem, context)

    self:onContextCreated(context)
end

function Env:onContextReleasedEvent(context)
    local destroySystemName = string.format("%s-DestroySystem", context:GetName())
    self.systems:UnregisterSystem(destroySystemName, true)

    local guidCollectionSystemName = string.format("%s-GUIDCollecionSystem", context:GetName())
    self.systems:UnregisterSystem(guidCollectionSystemName, true)

    local categoryCollectionSystemName = string.format("%s-CategoryCollecionSystem", context:GetName())
    self.systems:UnregisterSystem(categoryCollectionSystemName, true)

    local dependedCollectionSystemName = string.format("%s-DependedCollectionSystem", context:GetName())
    self.systems:UnregisterSystem(dependedCollectionSystemName, true)

    self:onContextReleased(context)
end

function Env:onContextsInitilized()
end

function Env:onSystemsInitilized()
end

function Env:onContextCreated(context)
end

function Env:onContextReleased(context)
end

return Env
