local oop = require("DotLua/ECS/OOP/oop")
local GroupUpdateSystem = require("DotLua/ECS/Systems/GroupUpdateSystem")
local CommonMatchers = require("DotLua/ECS/CommonMatchers")
local SystemPriorityConst = require("DotLua/ECS/Systems/SystemPriorityConst")
local FSMComponent = require("DotLua/ECS/Components/FSM/FSMComponent")
local FSMTransitionToComponent = require("DotLua/ECS/Components/FSM/FSMTransitionToComponent")
local FSMStateComponent = require("DotLua/ECS/Components/FSM/FSMStateComponent")

local LogTag = "FSMUpdateSystem"

local FSMUpdateSystem =
    oop.class(
    "DotLua.ECS.Systems.FSM.FSMUpdateSystem",
    function(self, context)
        self.priority = SystemPriorityConst.FSMUpdatePriority
    end,
    GroupUpdateSystem
)

function FSMUpdateSystem:createGroup(context)
    return context:CreateGroup(CommonMatchers.FSMUpdateMatcher)
end

function FSMUpdateSystem:filterEntity(entity)
    local fsmStateComponent = entity:GetComponent(FSMStateComponent)
    local currStateName = fsmStateComponent:GetCurrentState()
    if currStateName and #currStateName > 0 then
        return true
    end
end

function FSMUpdateSystem:onEntityUpdate(entity, deltaTime)
    local fsmComponent = entity:GetComponent(FSMComponent)
    local fsmData = fsmComponent:GetData()
    if not fsmData then
        oop.error(LogTag, "")
        return
    end

    local fsmStateComponent = entity:GetComponent(FSMStateComponent)
    local currentStateName = fsmStateComponent:GetCurrentState()

    if fsmData.updateGlobalBlackboard then
        fsmData.updateGlobalBlackboard(entity)
    end

    local currentState = fsmData.getState(currentStateName)
    if not currentState then
        oop.error(LogTag, "")
        return
    end

    currentState.DoUpdate(entity)

    local nextStateName = fsmData.getNextStateName(currentStateName, entity)
    if nextStateName ~= currentState then
        entity:AddComponent(FSMTransitionToComponent, nextStateName)
    end
end

return FSMUpdateSystem
