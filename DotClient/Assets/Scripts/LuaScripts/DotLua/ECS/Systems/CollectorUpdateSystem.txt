local oop = require("DotLua/ECS/OOP/oop")
local UpdateSystem = require("DotLua/ECS/Systems/Update/UpdateSystem")

local LogTag = "CollectorUpdateSystem"

local CollectorUpdateSystem =
    oop.class(
    "DotLua.ECS.Systems.Collectors.CollectorUpdateSystem",
    function(self, context)
        self.collector = self:createCollector(context)
    end,
    UpdateSystem
)

function CollectorUpdateSystem:onActivate()
    if self.collector then
        self.collector:DoActivate()
    end
end

function CollectorUpdateSystem:onDeactivate()
    if self.collector then
        self.collector:DoDeactivate()
    end
end

function CollectorUpdateSystem:onDestroy()
    if self.collector then
        self.collector:DoDestroy()
    end
    self.collector = nil
end

function CollectorUpdateSystem:onUpdate(deltaTime)
    if not self.collector then
        return
    end

    local isEntityUpdate,isAddedEntityUpdate,isRemovedEntityUdpate = self:getUpdateState()

    if isEntityUpdate then
        local entities = self.collector:GetCollectedEntities()
        if #entities > 0 then
            for _, entity in ipairs(entities) do
                if self:filterEntity(entity) then
                    self:onEntityUpdate(entity, deltaTime)
                end
            end
        end
    end

    if isAddedEntityUpdate then
        local entities = self.collector:GetCollectedAddedEntities()
        if #entities > 0 then
            for _, entity in ipairs(entities) do
                if self:filterEntity(entity) then
                    self:onAddedEntityUpdate(entity, deltaTime)
                end
            end
        end
    end

    if isRemovedEntityUdpate then
        local entities = self.collector:GetCollectedRemovedEntities()
        if #entities > 0 then
            for _, entity in ipairs(entities) do
                if self:filterEntity(entity) then
                    self:onRemovedEntityUpdate(entity, deltaTime)
                end
            end
        end
    end

    self.collector:ClearCollectedEntities()
end

function CollectorUpdateSystem:createCollector(context)
    return nil
end

function CollectorUpdateSystem:filterEntity(entity)
    return false
end

function CollectorUpdateSystem:getUpdateState()
    return true, false, false
end

function CollectorUpdateSystem:onEntityUpdate(entity, deltaTime)
    oop.error(LogTag, "this is a abstract class")
end

function CollectorUpdateSystem:onAddedEntityUpdate(entity, deltaTime)
    oop.error(LogTag, "this is a abstract class")
end

function CollectorUpdateSystem:onRemovedEntityUpdate(entity, deltaTime)
    oop.error(LogTag, "this is a abstract class")
end

return CollectorUpdateSystem
