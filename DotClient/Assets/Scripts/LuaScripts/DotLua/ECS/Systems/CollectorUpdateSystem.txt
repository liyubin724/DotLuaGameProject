local oop = require("DotLua/ECS/OOP/oop")
local UpdateSystem = require("DotLua/ECS/Systems/Update/UpdateSystem")

local LogTag = "CollectorUpdateSystem"

local CollectorUpdateSystem =
    oop.class(
    "DotLua.ECS.Systems.Collectors.CollectorUpdateSystem",
    function(self, context)
        self.collector = self:createCollector(context)
    end,
    UpdateSystem
)

function CollectorUpdateSystem:onActivate()
    if self.collector then
        self.collector:DoActivate()
    end
end

function CollectorUpdateSystem:onDeactivate()
    if self.collector then
        self.collector:DoDeactivate()
    end
end

function CollectorUpdateSystem:onDestroy()
    if self.collector then
        self.collector:DoDestroy()
    end
    self.collector = nil
end

function CollectorUpdateSystem:onUpdate(deltaTime)
    if not self.collector then
        return
    end

    local collectedEnities = self.collector:GetCollectedEntities()
    if collectedEnities and #collectedEnities > 0 then
        for _, entity in ipairs(collectedEnities) do
            if self:filterEntity(entity) then
                self:onEntityUpdate(entity, deltaTime)
            end
        end
        self.collector:ClearCollectedEntities()
    end
end

function CollectorUpdateSystem:createCollector(context)
    return nil
end

function CollectorUpdateSystem:filterEntity(entity)
    return false
end

function CollectorUpdateSystem:onEntityUpdate(entity, deltaTime)
    oop.error(LogTag, "this is a abstract class")
end

return CollectorUpdateSystem
