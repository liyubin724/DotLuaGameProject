local oop = require("DotLua/OOP/oop")
local CommonMatchers = require("DotLua/ECS/CommonMatchers")
local EGroupEvent = require("DotLua/ECS/Core/EGroupEvent")
local Collector = require("DotLua/ECS/Core/Collector")
local Const = require("DotLua/ECS/Const")
local CategoryComponent = require("DotLua/ECS/Components/Basic/CategoryComponent")
local CategoryCollectionComponent = require("DotLua/ECS/Components/Basic/Collection/CategoryCollectionComponent")
local CollectorUpdateSystem = require("DotLua/ECS/Systems/CollectorUpdateSystem")
local SystemPriorityConst = require("DotLua/ECS/Systems/SystemPriorityConst")

local CategoryCollectionSystem =
    oop.class(
    "DotLua.ECS.Systems.Basic.CategoryCollectionSystem",
    function(self, context)
        self.priority = SystemPriorityConst.CategoryCollectionPriority
    end,
    CollectorUpdateSystem
)

function CategoryCollectionSystem:createCollector(context)
    return Collector(context, CommonMatchers.HaveCategoryComponentMatcher, EGroupEvent.AddedOrRemoved)
end

function CategoryCollectionSystem:onAddedEntityUpdate(entity, deltaTime)
    local collectionEntity = ecs.GetGlobalEntity(Const.GLOBAL_ENTITY_COLLECTION_NAME)
    local categoryCollectionComponent = collectionEntity:GetComponent(CategoryCollectionComponent)

    local categoryComponent = entity:GetComponent(CategoryComponent)
    local categoryID = categoryComponent:GetCategoryID()
    
    local contextName, guid = entity:GetIdentity()
    categoryCollectionComponent:AddEntity(categoryID, contextName, guid)
end

function CategoryCollectionSystem:onRemovedEntityUpdate(entity, deltaTime)
    local collectionEntity = ecs.GetGlobalEntity(Const.GLOBAL_ENTITY_COLLECTION_NAME)
    local categoryCollectionComponent = collectionEntity:GetComponent(CategoryCollectionComponent)

    local categoryComponent = entity:GetComponent(CategoryComponent)
    local categoryID = categoryComponent:GetCategoryID()

    local contextName, guid = entity:GetIdentity()
    categoryCollectionComponent:RemoveEntity(categoryID, contextName, guid)
end

return CategoryCollectionSystem
