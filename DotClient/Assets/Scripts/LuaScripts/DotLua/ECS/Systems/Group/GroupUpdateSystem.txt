local oop = require("DotLua/ECS/OOP/oop")
local UpdateSystem = require("DotLua/ECS/Systems/UpdateSystem")

local tclear = table.clear
local tcopyto = table.copyto

local LogTag = "GroupUpdateSystem"

local GroupUpdateSystem =
    oop.class(
    "DotLua.ECS.Systems.Group.GroupUpdateSystem",
    function(self, context)
        self.context = context
        self.group = nil

        self.tempEntities = {}
    end,
    UpdateSystem
)

function GroupUpdateSystem:onInitlize()
    self._base.onInitlize(self)

    self.group = self:createGroup(self.context)
end

function GroupUpdateSystem:onDestroy()
    if self.group then
        self.context:ReleaseGroup(self.group)
    end
    self.group = nil
    self.context = nil
end

function GroupUpdateSystem:onUpdate(deltaTime)
    if not self.group then
        return
    end

    local groupEntities = self.group:GetEntities()
    tcopyto(groupEntities,self.tempEntities)

    for i = 1, #self.tempEntities do
        local entity = self.tempEntities[i]
        if self:filterEntity(entity) then
            self:onEntityUpdate(entity, deltaTime)
        end
    end

    tclear(self.tempEntities)
end

function GroupUpdateSystem:createGroup(context)
    oop.error(LogTag, "this is a abstract class")
    return nil
end

function GroupUpdateSystem:filterEntity(entity)
    return true
end

function GroupUpdateSystem:onEntityUpdate(entity, deltaTime)
    oop.error(LogTag, "this is a abstract class")
end

return GroupUpdateSystem
