local oop = require("DotLua/ECS/OOP/oop")
local LateUpdateSystem = require("DotLua/ECS/Systems/Update/LateUpdateSystem")

local tclear = table.clear
local tcopyto = table.copyto

local LogTag = "GroupLateUpdateSystem"

local GroupLateUpdateSystem =
    oop.class(
    "DotLua.ECS.Systems.Group.GroupLateUpdateSystem",
    function(self, context)
        self.context = context
        self.group = nil

        self.tempEntities = {}
    end,
    LateUpdateSystem
)

function GroupLateUpdateSystem:onInitlize()
    self:GetBaseClass().onInitlize(self)
    self.group = self:createGroup(self.context)
end

function GroupLateUpdateSystem:onDestroy()
    if self.group then
        self.context:ReleaseGroup(self.group)
    end
    self.group = nil
    self.context = nil
end

function GroupLateUpdateSystem:onLateUpdate(deltaTime)
    if not self.group then
        return
    end

    local groupEntities = self.group:GetEntities()
    tcopyto(groupEntities,self.tempEntities)

    for i = 1, #self.tempEntities do
        local entity = self.tempEntities[i]
        if self:filterEntity(entity) then
            self:onEntityLateUpdate(entity, deltaTime)
        end
    end

    tclear(self.tempEntities)
end

function GroupLateUpdateSystem:createGroup(context)
    oop.error(LogTag, "this is a abstract class")
    return nil
end

function GroupLateUpdateSystem:filterEntity(entity)
    return true
end

function GroupLateUpdateSystem:onEntityLateUpdate(entity, deltaTime)
    oop.error(LogTag, "this is a abstract class")
end

return GroupLateUpdateSystem
