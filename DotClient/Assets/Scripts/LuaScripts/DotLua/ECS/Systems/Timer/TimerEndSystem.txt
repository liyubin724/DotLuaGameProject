local oop = require("DotLua/OOP/oop")
local CollectorUpdateSystem = require("DotLua/ECS/Systems/CollectorUpdateSystem")
local SystemPriorityConst = require("DotLua/ECS/Systems/SystemPriorityConst")
local CommonMatchers = require("DotLua/ECS/CommonMatchers")
local EGroupEvent = require("DotLua/ECS/Core/EGroupEvent")
local Collector = require("DotLua/ECS/Core/Collector")
local TimerComponent = require("DotLua/ECS/Components/Timer/TimerComponent")
local TimerEndComponent = require("DotLua/ECS/Components/Timer/TimerEndComponent")
local DestroyComponent = require("DotLua/ECS/Components/Basic/DestroyComponent")

local TimerEndSystem =
    oop.class(
    "DotLua.ECS.Systems.Timer.TimerEndSystem",
    function(self, context)
        self.priority = SystemPriorityConst.TimerEndPriority
    end,
    CollectorUpdateSystem
)

function TimerEndSystem:createCollector(context)
    return Collector(context, CommonMatchers.TimerEndMatcher, EGroupEvent.Added)
end

function TimerEndSystem:onAddedEntityUpdate(entity, deltaTime)
    local timerComponent = entity:GetComponent(TimerComponent)
    if timerComponent:IsRunning() then
        local timerServicer = ecs.GetTimerServicer()
        timerServicer:RemoveTimer(entity)
    end
    local timerEndComponentClass = timerComponent:GetEndComponentClass()
    if timerEndComponentClass then
        local userdata = timerComponent:GetUserdata()
        entity:AddComponent(timerEndComponentClass, userdata)
    end
    entity:ReplaceComponent(TimerEndComponent, DestroyComponent)
end

return TimerEndSystem
