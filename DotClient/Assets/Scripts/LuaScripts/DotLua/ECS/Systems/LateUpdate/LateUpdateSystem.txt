local oop = require("DotLua/OOP/oop")
local System = oop.using("DotLua/ECS/Systems/System")
local Const = require("DotLua/ECS/Const")

local LateUpdateSystem =
    oop.class(
    "DotLua.ECS.Systems.LateUpdate.LateUpdateSystem",
    function(self)
        self.frequencyTime = Const.TIME_EVERY_UPDATE

        self.elapseDeltaTime = 0
        self.elapseUnscaleDeltaTime = 0
    end,
    System
)

function LateUpdateSystem:GetFrequencyTime()
    return self.frequencyTime
end

function LateUpdateSystem:onActivate()
    self.elapseDeltaTime = 0
    self.elapseUnscaleDeltaTime = 0
end

function LateUpdateSystem:DoLateUpdate(deltaTime, unscaleDeltaTime)
    local onLateUpdateFunc = self[Const.ON_LATEUPDATE_FUNC_NAME]
    if onLateUpdateFunc then
        self.elapseDeltaTime = self.elapseDeltaTime + deltaTime

        if self.elapseDeltaTime >= self.frequencyTime then
            onLateUpdateFunc(self, deltaTime)
            if self.frequencyTime <= 0 then
                self.elapseDeltaTime = 0
            else
                self.elapseDeltaTime = self.elapseDeltaTime - self.frequencyTime
            end
        end
    end

    local onUnscaleLateUpdate = self[Const.ON_UNSCALE_LATEUPDATE_FUNC_NAME]
    if onUnscaleLateUpdate then
        self.elapseUnscaleDeltaTime = self.elapseUnscaleDeltaTime + unscaleDeltaTime
        if self.elapseDeltaTime >= self.frequencyTime then
            onUnscaleLateUpdate(self, unscaleDeltaTime)
            if self.frequencyTime <= 0 then
                self.elapseUnscaleDeltaTime = 0
            else
                self.elapseUnscaleDeltaTime = self.elapseUnscaleDeltaTime - self.frequencyTime
            end
        end
    end
end

-- function LateUpdateSystem:onLateUpdate(deltaTime)
-- end

-- function LateUpdateSystem:onUnscaleLateUpdate(unscaleDeltaTime)
-- end

return LateUpdateSystem
