<%
using DotEngine.Context;
using System.Text;
using DotEngine.Config.WDB;

public static class TemplateRunner {
    public static string Run(StringContextContainer context){
        StringBuilder output = new StringBuilder();

        WDBSheet sheet = context.Get<WDBSheet>("__sheet__");
        string sheetName = sheet.Name;
        int fieldCount = sheet.FieldCount;
        int lineCount = sheet.LineCount;%>
local <%=sheetName%> = {<%

for(int i =0;i < lineCount; ++i){
WDBLine line = sheet.GetLineAtIndex(i);
WDBCell fCell = line.GetCellByIndex(0);
string fContent = fCell.Value;%>
    [<%=fContent%>] = {
<%
    for(int j = 0;j<fieldCount;++j){
    WDBField field = sheet.GetFieldAtIndex(j);
    WDBCell cell = line.GetCellByIndex(j);
    string content = cell.GetValue(field);
    if(content == null)
    {
        content = "";
    }

    string format = "{0}";
    WDBFieldType fieldType = field.FieldType;
    if(fieldType == WDBFieldType.String 
        || fieldType == WDBFieldType.Text
        || fieldType == WDBFieldType.Address)
    {
        format = "[[{0}]]";
    }else if(fieldType == WDBFieldType.Bool)
    {
        content = content.ToLower();
    }else if(fieldType == WDBFieldType.Lua)
    {
        content = "function() \n         "+content+"\n        end";
    }

%>        <%=field.Name%> = <%=string.Format(format,content)%>,
<%}%>
    },<%}%>
}
return <%=sheetName%>

<%
return output.ToString();
    }
}
%>