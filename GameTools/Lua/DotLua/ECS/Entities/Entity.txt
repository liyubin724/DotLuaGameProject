local oop = require('DotLua/OOP/oop')
local Component = require('DotLua/ECS/Components/Component')
local GUIDComponent = require('DotLua/ECS/Components/Basic/GUIDComponent')
local CatgoryComponent = require('DotLua/ECS/Components/Basic/CatgoryComponent')

local tlength = table.length
local tvalues = table.values
local tclear = table.clear
local tfindanyvalue = table.findanyvalue

local LogTag = 'Entity'

local Entity =
    oop.class(
    'DotLua.ECS.Entities.Entity',
    function(self)
        self.enable = true

        self.context = nil

        self.nameToComponnentDic = {}

        self.onComponentAddedEvent = oop.event()
        self.onComponentRemovedEvent = oop.event()
        self.onComponentReplacedEvent = oop.event()
        self.onComponentModifiedEvent = oop.event()

        self.guid = nil
        self.catgory = nil
    end
)

function Entity:GetContext()
    return self.context
end

function Entity:GetGUID()
    if not self.guid then
        local guidComponent = self:GetComponentByClass(GUIDComponent)
        self.guid = guidComponent:GetGUID()
    end

    return self.guid
end

function Entity:GetCatgory()
    if not self.catgory then
        local catgoryComponent = self:GetComponentByClass(CatgoryComponent)
        self.catgory = catgoryComponent:GetCatgory()
    end

    return self.catgory
end

function Entity:DoGet(context)
    self.enable = true

    self.context = context
end

function Entity:DoRelease()
    self.enable = false
    self.guid = nil

    self.onComponentAddedEvent:Clear()
    self.onComponentRemovedEvent:Clear()
    self.onComponentReplacedEvent:Clear()
    self.onComponentModifiedEvent:Clear()

    local values = tvalues(self.nameToComponnentDic)
    tclear(self.nameToComponnentDic)
    for i = 1, #values, 1 do
        self.context:releaseComponent(values[i])
    end
    self.context = nil
end

function Entity:BindEvent(receiver, addedFunc, removedFunc, replacedFunc, modifiedFunc)
    if addedFunc then
        self.onComponentAddedEvent:Add(receiver, addedFunc)
    end

    if removedFunc then
        self.onComponentRemovedEvent:Add(receiver, removedFunc)
    end

    if replacedFunc then
        self.onComponentReplacedEvent:Add(receiver, replacedFunc)
    end

    if modifiedFunc then
        self.onComponentModifiedEvent:Add(receiver, modifiedFunc)
    end
end

function Entity:UnbindEvent(receiver, addedFunc, removedFunc, replacedFunc, modifiedFunc)
    if addedFunc then
        self.onComponentAddedEvent:Remove(receiver, addedFunc)
    end

    if removedFunc then
        self.onComponentRemovedEvent:Remove(receiver, removedFunc)
    end

    if replacedFunc then
        self.onComponentReplacedEvent:Remove(receiver, replacedFunc)
    end

    if modifiedFunc then
        self.onComponentModifiedEvent:Remove(receiver, modifiedFunc)
    end
end

function Entity:UnbindAllEvent()
    self.onComponentAddedEvent:Clear()
    self.onComponentRemovedEvent:Clear()
    self.onComponentReplacedEvent:Clear()
    self.onComponentModifiedEvent:Clear()
end

function Entity:GetComponentCount()
    return tlength(self.nameToComponnentDic)
end

function Entity:GetAllComponents()
    return tvalues(self.nameToComponnentDic)
end

function Entity:HasComponentByClass(componentClass)
    if oop.isDebug then
        if not oop.isclass(componentClass) or not oop.isclassof(componentClass, Component) then
            oop.error(LogTag, 'Entity:HasComponent->the param is not a class')
            return false
        end
    end

    return tfindanyvalue(
        self.nameToComponnentDic,
        function(v)
            if v:GetBaseClass() == componentClass then
                return true
            end
            return false
        end
    )
end

function Entity:HasComponentByName(name)
    return self.nameToComponnentDic[name] ~= nil
end

function Entity:HasAllComponentsByClass(componentClasses)
    for _, componentClass in ipairs(componentClasses) do
        if not self:HasComponentByClass(componentClass) then
            return false
        end
    end

    return true
end

function Entity:HasAllComponentsByName(names)
    for _, name in ipairs(names) do
        if not self:HasComponentByClass(name) then
            return false
        end
    end

    return true
end

function Entity:HasAnyComponentByClass(componentClasses)
    for _, componentClass in ipairs(componentClasses) do
        if self:HasComponentByClass(componentClass) then
            return true
        end
    end

    return false
end

function Entity:HasAnyComponentByName(names)
    for _, name in ipairs(names) do
        if self:HasComponentByName(name) then
            return true
        end
    end

    return false
end

function Entity:GetComponentByClass(componentClass)
    if oop.isDebug then
        if not oop.isclass(componentClass) or not oop.isclassof(componentClass, Component) then
            oop.error(LogTag, 'the param is not a class of Component')
            return nil
        end
    end

    return self.componentClassToInstanceDic[componentClass]
end

function Entity:AddComponentByClass(componentClass, ...)
    if not self.enable then
        oop.error(LogTag, 'The enity has been disabled')
        return nil
    end

    if oop.isDebug then
        if not oop.isclass(componentClass) or not oop.isclassof(componentClass, Component) then
            oop.error(LogTag, 'the param is not a class of Component')
            return nil
        end
    end

    if self:HasComponentByClass(componentClass) then
        oop.error(LogTag, string.format('The component of %s has beend added!', componentClass:GetClassName()))
        return nil
    end

    local component = self:addComponent(componentClass, ...)
    if not component then
        self.onComponentAddedEvent:Invoke(self, componentClass)
    end
    return component
end

function Entity:RemoveComponentByClass(componentClass)
    if not self.enable then
        oop.error(LogTag, 'The enity has been disabled')
        return
    end

    if oop.isDebug then
        if not oop.isclass(componentClass) or not oop.isclassof(componentClass, Component) then
            oop.error(LogTag, 'the param is not a class of Component')
            return nil
        end
    end

    local component = self:removeComponent(componentClass)
    if not component then
        self.onComponentRemovedEvent:Invoke(self, componentClass)
        self.context:releaseComponent(component)
    end
end

function Entity:ReplaceComponentByClass(oldComponentClass, newComponentClass)
    if not self.enable then
        oop.error(LogTag, 'The enity has been disabled')
        return nil
    end

    if not oldComponentClass and not newComponentClass then
        oop.error(LogTag, 'the component is nil')
        return nil
    end

    if oop.isDebug then
        if oldComponentClass and (not oop.isclass(oldComponentClass) or not oop.isclassof(oldComponentClass, Component)) then
            oop.error(LogTag, 'the param is not a class of Component')
            return nil
        end

        if newComponentClass and (not oop.isclass(newComponentClass) or not oop.isclassof(newComponentClass, Component)) then
            oop.error(LogTag, 'the param is not a class of Component')
            return nil
        end
    end

    if oldComponentClass and not newComponentClass then
        self:RemoveComponent(oldComponentClass)
    elseif oldComponentClass and newComponentClass then
        local oldComponent = self:removeComponent(oldComponentClass)
        local newComponent = self:addComponent(newComponentClass)
        self.onComponentReplacedEvent:Invoke(self, oldComponentClass, newComponentClass)
        self.context:releaseComponent(oldComponent)
        return newComponent
    elseif not oldComponentClass and newComponentClass then
        return self:AddComponentByClass(newComponentClass)
    end
end

function Entity:ModifyComponentByClass(componentClass, modifyDelegate, modifyTag)
    if not self.enable then
        oop.error(LogTag, 'The enity has been disabled')
        return
    end

    if oop.isDebug then
        if not oop.isclass(componentClass) or not oop.isclassof(componentClass, Component) then
            oop.error(LogTag, 'the param is not a class of Component')
            return
        end
    end

    local component = self.componentClassToInstanceDic[componentClass]
    if not component then
        oop.error(LogTag, 'the component is not found')
        return
    end

    if not modifyDelegate then
        modifyDelegate:ActionInvoke(self, component, modifyTag)
        self.onComponentModifiedEvent:Invoke(self, componentClass, modifyTag)
    end
end

function Entity:Destroy()
    self.context:DestroyEntity(self)
end

function Entity:MarkComponentModifiedByClass(componentClass, modifyTag)
    if not self.enable then
        oop.error(LogTag, 'The enity has been disabled')
        return
    end

    if oop.isDebug then
        if not oop.isclass(componentClass) or not oop.isclassof(componentClass, Component) then
            oop.error(LogTag, 'the param is not a class of Component')
            return
        end
    end

    local component = self.componentClassToInstanceDic[componentClass]
    if not component then
        oop.error(LogTag, 'the component is not found')
        return
    end

    self.onComponentModifiedEvent:Invoke(self, componentClass, modifyTag)
end

function Entity:addComponent(componentClass, ...)
    local component = self.context:getComponent(componentClass, ...)
    if not component then
        oop.error(LogTag, 'the component is nil')
        return nil
    end

    self.componentClassToInstanceDic[componentClass] = component

    return component
end

function Entity:removeComponent(componentClass)
    local component = self.componentClassToInstanceDic[componentClass]
    if not component then
        oop.error(LogTag, 'The component is not found')
        return
    end

    self.componentClassToInstanceDic[componentClass] = nil
    return component
end

return Entity
